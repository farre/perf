<style>
  * {
    font-family: sans-serif;
    font-size: 18px;
  }

  li {
    width: 80vw;
    max-width: 1000px;
    margin-bottom: 8px;
  }

  select {
    width: 20vw;
    min-width: 200px;

    float: right;
    clear: right;
  }
</style>

<script>
  const treeherder = "https://treeherder.mozilla.org/jobs?repo=try&revision=";

  function perfherder(entry, newEntry) {
    const name = `${entry.name} vs ${newEntry.name}`;
    const url = `https://treeherder.mozilla.org/perfherder/compare?originalProject=try&originalRevision=${entry.sha}&newProject=try&newRevision=${newEntry.sha}`;
    return { name, url };
  }

  const runs = {
      Desktop: [
        { name: "Base", sha: "12d978ebebacc823350c3f524a2335453c16882a" },
        { name: "PCN", sha: "bf5dc428432235b43a982436426918b4f5a4b979" },
        { name: "PCN+Speculative", sha: "66a541e93772a1f8daae82855dde29ef2ee71d03" }
      ],
    };
  const groups = Object.keys(runs);

  function getLists() {
    return Object.fromEntries(groups.map(g => [g, document.createElement("ul")]));
  }

  function createItem(group, name, sha, compareWith) {
    const url = `${treeherder}${sha}`;

    let anchor = document.createElement("a");
    anchor.href = url;
    anchor.innerText = name;
    let item = document.createElement("li");
    item.appendChild(anchor);

    let comp = document.createElement("select");

    let compHelp = document.createElement("option");
    compHelp.selected = true;
    compHelp.disabled = true;
    compHelp.innerText = "Compare with...";
    comp.appendChild(compHelp);

    for (let run of runs[group]) {
      const runName = `${group} ${run.name}`;
      if (runName == name) continue;

      let opt = document.createElement("option");
      opt.innerText = runName;
      opt.onclick = () => {
        window.open(
          `https://treeherder.mozilla.org/perfherder/compare?originalProject=try&originalRevision=${sha}&newProject=try&newRevision=${run.sha}&framework=13&page=1&showOnlyImportant=1`,
          "_blank"
        );
        comp.selectedIndex = 0;
      };

      comp.appendChild(opt);
    }
    comp.appendChild(document.createElement("hr"));
    item.appendChild(comp);

    return item;
  }

  function initTreeherder() {
    const lists = getLists();
    for (let [group, entries] of Object.entries(runs)) {
      for (let run of entries) {
        const list = lists[group];
        const item = createItem(group, `${group} ${run.name}`, run.sha);
        list.appendChild(item);
      }
    }
    let treeherderRuns = document.getElementById("treeherder");
    for (let list of Object.values(lists)) {
      treeherderRuns.appendChild(list);
    }
  }

  function init() {
    initTreeherder();
  }
  addEventListener("load", init);
</script>
<div id="treeherder"></div>
<br />
<div id="perfherder"></div>

<p>
  When selecting a comparison, the profile in the dropdown will be the new with
  the list item as the base.
</p>

<p>
  Previous rounds of profiling can be found <a href="old/">here</a>
</p>
